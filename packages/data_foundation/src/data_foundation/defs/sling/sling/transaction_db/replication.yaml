# Incremental loads with a composite key that downstream fact tables expect.
# https://docs.slingdata.io/concepts/replication

# yaml-language-server: $schema=../.schema/replication.json
name: transaction_db->snowflake
env: {SLING_LOADED_AT_COLUMN: timestamp}
source: transaction_db
target: snowflake
defaults: 
    mode: incremental
    object: '{stream_schema_upper}.{stream_table_upper}'
    primary_key: [id]
    update_key: date_time
    target_options:
        column_casing: snake
        add_new_columns: true
        adjust_column_type: true
streams:
    # Captures the order line items. Keep the composite key aligned with dbt
    # expectations when modeling fct_common__fct_transactions.
    transaction_db.transactions:
        primary_key: [order_id, product_id]
        meta:
            dagster:
                automation_condition: "on_schedule"
                automation_condition_config: {"cron_schedule":"@daily", "cron_timezone":"utc"}
                # freshness_check: {"lower_bound_delta_seconds": 129600}